{% include 'base3.html' %} 
{% load static %}

<body>
  <main id="main" class="main">
    <!-- Page Title -->
    <div class="pagetitle bg-white p-2">
      <h1>Cattle List</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
          <li class="breadcrumb-item active"><a href="{% url 'cattle_list' %}">Back</a></li>
        </ol>
      </nav>
    </div>

    <!-- Cattle List Section -->
    <section class="section">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">
              <h2 class="card-title mb-4">Cattle List</h2>
              <form method="POST" action="{% url 'add_cattle' %}" enctype="multipart/form-data">
                     {% csrf_token %}
                      <div class="col-md-2 d-flex align-items-center">
                        <label for="excel_file" class="btn btn-secondary btn-sm">Choose File</label>
                        <input type="file" id="excel_file" name="excel_file" accept=".xlsx,.xls" style="display:none;">
                        <button type="submit" class="btn btn-primary btn-sm px-2">Upload</button>
                    </div>

                  </form>

              {% if messages %}
                <div class="container mt-3">
                  {% for message in messages %}
                    <div class="alert alert-info {{ message.tags }} alert-dismissible fade show" role="alert">
                      <h5 class="text-center">{{ message }}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                  {% endfor %}
                 </div>
                 {% endif %}
                 
                 <!-- Filter Form -->
                <form method="get" class="row g-3 mb-5">
                  <div class="col-md-2">
                   <label for="name" class="form-label fw-bold">Tag Name</label>
                    <input type="text" name="name" id="tag_name" class="form-control" 
                   value="{{ request.GET.name }}" placeholder="Enter tag name">
                 </div>
                 <div class="col-md-2">
                   <label for="batch" class="form-label fw-bold">Unit</label>
                   <select name="batch" id="batch" class="form-select">
                     <option value="">All Units</option>
                     {% for batch in batches %}
                     <option value="{{ batch.id }}" {% if request.GET.batch == batch.id|stringformat:"s" %}selected{% endif %}>{{ batch.name }}</option>
                     {% endfor %}
                   </select>
                  </div>
                 <div class="col-md-2">
                   <label for="health_status" class="form-label fw-bold">Health Status</label>
                   <select name="health_status" id="health_status" class="form-select">
                     <option value="">All Status</option>
                      {% for key, value in health_choices %}
                      <option value="{{ key }}" {% if request.GET.health_status == key %}selected{% endif %}>
                      {{ value }}
                      </option>
                     {% endfor %}
                   </select>
                  </div>

                  <div class="col-md-2">
                   <label for="breeding" class="form-label fw-bold">All Status</label>
                   <select name="status" class="form-control" onchange="this.form.submit()">
                     <option value="">Status</option>
                     <option value="Fresh" {% if status == "Fresh" %}selected{% endif %}>Fresh</option>
                     <option value="Inseminated" {% if status == "Inseminated" %}selected{% endif %}>Inseminated</option>
                     <option value="Pregnant" {% if status == "Pregnant" %}selected{% endif %}>Pregnant</option>
                     <option value="Dry" {% if status == "Dry" %}selected{% endif %}>Dry</option>
                     <option value="Sold" {% if status == "Sold" %}selected{% endif %}>Sold</option>
                     <option value="Salvage" {% if status == "Salvage" %}selected{% endif %}>Salvage</option>
                   </select>
                  </div>


                  <div class="col-md-2 d-flex align-items-end">
                   <button type="submit" class="btn btn-sm btn-primary me-2 px-4">Filter</button>
                    <a href="{% url 'cattle_list' %}" class="btn btn-sm btn-danger px-4">Clear</a>
                  </div>
    
                 <!-- Button to open modal -->
                  <div class="col-md-2 col-md-2 d-flex align-items-center">
                    <button type="button" class="btn btn-success me-2 px-4" data-bs-toggle="modal" data-bs-target="#addCattleModal">
                      Add Cattle
                    </button>
                  </div>
                </form>
                <!-- Modal -->
               <div class="modal fade" id="addCattleModal" tabindex="-1" aria-labelledby="addCattleModalLabel" aria-hidden="true">
                 <div class="modal-dialog modal-lg">
                   <div class="modal-content">
                    <div class="modal-header bg-success">
                      <h5 class="modal-title text-light" id="addCattleModalLabel">Add Cattle</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
      <div class="modal-body">
        <!-- Form starts -->
        <form method="POST" action="{% url 'add_cattle' %}">
          {% csrf_token %}
          <div class="row">

            <!-- Batch -->
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Batch</label>
              <select name="batch" id="batchSelect" class="form-control" required>
                <option>Select Unit</option>
                {% for batch in batches %}
                  <option value="{{ batch.id }}">{{ batch.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Tag Name -->
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Tag Name</label>
              <input type="text"  name="name" class="form-control" placeholder="125" required>
            </div>

            <!-- Age -->
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Age</label>
              <input type="number" name="age" class="form-control" required>
            </div>

            <!-- Breed -->
            <div class="col-lg-4 mb-3">
  <label class="form-label fw-bold">Breed</label>
  <select name="breed" class="form-control" required>
    <option value="Murrah">Murrah</option>
    <option value="Jaffarabadi">Jaffarabadi</option>
    <option value="Surti">Surti</option>
    <option value="Mehsana">Mehsana</option>
    <option value="Nili-Ravi">Nili-Ravi</option>
    <option value="Bhadawari">Bhadawari</option>
    <option value="Pandharpuri">Pandharpuri</option>
  </select>
</div>


            <!-- Milk -->
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Milk (Ltr)</label>
              <input type="number" step="0.01" name="milk" class="form-control">
            </div>

            <!-- Purchase Date -->
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Purchase Date</label>
              <input type="date" name="purchase" class="form-control">
            </div>

            <!-- Purchase Amount -->
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Purchase Amount</label>
              <input type="number"  name="purchase_amount" class="form-control">
            </div>

            <!-- Breeding -->
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Breeding</label>
              <select name="breeding" class="form-control">
              <option value="Fresh">Fresh</option>
              <option value="Inseminated">Inseminated</option>
              <option value="Pregnant">Pregnant</option>
             <option value="Dry">Dry</option>
             </select>
            </div>


            <!-- Health Status -->
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Health Status</label>
              <select class="form-control" name="health_status" required>
                <option value="Healthy">Healthy</option>
                <option value="Sick">Sick</option>
              </select>
            </div>

            <!-- Convincing Date -->
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Convincing Date</label>
              <input type="date" name="convincing_date" class="form-control">
            </div>

            <!-- Result -->
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Result</label>
              <input type="text" name="result" class="form-control">
            </div>

            <!-- Milk Days -->
            {% comment %} <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Milk Day 0</label>
              <input type="number" step="0.01" name="milk_day_0" class="form-control">
            </div> {% endcomment %}
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Milk Day 15</label>
              <input type="number"  name="milk_day_15" class="form-control">
            </div>
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Milk Day 30</label>
              <input type="number"  name="milk_day_30" class="form-control">
            </div>
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Milk Day 60</label>
              <input type="number"  name="milk_day_60" class="form-control">
            </div>
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Milk Day 75</label>
              <input type="number"  name="milk_day_75" class="form-control">
            </div>

            <!-- Outward Date -->
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Outward Date</label>
              <input type="date" name="outward_date" class="form-control">
            </div>

            {% comment %} <!-- Sale Date -->
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Sale Date</label>
              <input type="date" name="sale_date" class="form-control">
            </div>

            <!-- Sold -->
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Sold</label>
              <input type="text" name="sold" class="form-control">
            </div>

            <!-- Salvage Date -->
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Salvage Date</label>
              <input type="date" name="salvage_date" class="form-control">
            </div>

            <!-- Salvage -->
            <div class="col-lg-4 mb-3">
              <label class="form-label fw-bold">Salvage</label>
              <input type="text" name="salvage" class="form-control">
            </div> {% endcomment %}

          </div>

          <div class="text-center mt-3">
            <button class="btn btn-success px-4" type="submit">Add Cattle</button>
            <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Close</button>
          </div>
        </form>
        <!-- Form ends -->
      </div>
    </div>
  </div>
</div>


<div class="table-responsive">
  <table class="table table-striped table-hover" style="white-space: nowrap;">
    <thead class="table-light">
      <tr>
        <th>Sr. No.</th>
        <th>Tag Name</th>
        <th>Batch</th>
        <th>Purchase Info</th>
        <th>Milk (Ltr)</th>
        <th>15d Milk</th>
        <th>30d Milk</th>
        <th>60d Milk</th>
        <th>75d Milk</th>
        <th>Breed</th>
        <th>Breeding</th>
        <th>Convincing Date</th>
        <th>Result</th>
        <th>Outward Date</th>
        <th>Sale Date / Status</th>
        <th>Status</th>
        <th>Health Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for cattle in cattles %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ cattle.name }}<br>
               {% if cattle.reentered %}
                <span class="text-warning">★</span>
              {% endif %}
          </td>
          <td>
            {{ cattle.batch.name }}<br>
            <span class="badge bg-info text-light">In-{{ cattle.purchase|date:"d-m-Y" }}</span>
          </td>
          <td>
            {{ cattle.purchase|date:"d-m-Y" }}<br>
            <span class="badge bg-success">₹ {{ cattle.purchase_amount|default:0|floatformat:2 }}</span>
          </td>
          <td>
               <span class="mx-2"> {{ cattle.milk|default:0|floatformat:2 }} Ltr</span><br>
             {% comment %} <span class="mx-2">15d: {{ cattle.milk_day_15|floatformat:1 }}</span>
             <span class="mx-2">30d: {{ cattle.milk_day_30|floatformat:1 }}</span><br>
             <span class="mx-2">60d: {{ cattle.milk_day_60|floatformat:1 }}</span>
             <span class="mx-2">75d: {{ cattle.milk_day_75|floatformat:1 }}</span>  {% endcomment %}
            </td>
            <td>{{ cattle.milk_day_15|floatformat:1 }}</td>
            <td>{{ cattle.milk_day_30|floatformat:1 }}</td>
            <td>{{ cattle.milk_day_60|floatformat:1 }}</td>
            <td>{{ cattle.milk_day_75|floatformat:1 }}</td>

          <td>{{ cattle.breed }}</td>
          <td>{{ cattle.breeding }}</td>

          <!-- Convincing Date with highlight logic -->
          <td
            {% if cattle.convincing_date <= today %}
            {% elif cattle.convincing_date <= today|add:'3' %}
            {% endif %}
          >
            {{ cattle.convincing_date|date:"d-m-Y" }}
            {% if cattle.convincing_date <= today %}
              <br><span class="badge bg-danger text-light"> Missed! </span>
            {% elif cattle.convincing_date <= today|add:'3' %}
              <br><span class="badge bg-warning text-light"> Expiring Soon </span>
            {% endif %}
          </td>

          <td><span class="badge bg-warning text-dark">{{ cattle.result }}</span></td>
          <td>{{ cattle.outward_date|date:"d-m-Y" }}</td>
          <td>
            {{ cattle.sale_date|date:"d-m-Y" }}
            {% if cattle.sold %}
              <br><span class="badge bg-danger text-light">₹ {{ cattle.sold }}</span>
            {% endif %}
          </td>
          <td><span class="badge bg-info">{{ cattle.salvage }}</span></td>

          <td>
            {% if cattle.health_status == "Healthy" %}
              <span class="badge bg-success">{{ cattle.health_status }}</span>
            {% elif cattle.health_status == "Sick" %}
              <span class="badge bg-warning text-dark">{{ cattle.health_status }}</span>
            {% elif cattle.health_status == "Critical" %}
              <span class="badge bg-danger">{{ cattle.health_status }}</span>
            {% else %}
              {{ cattle.health_status }}
            {% endif %}
          </td>
         <td>
  <!-- SALE BUTTON -->
  <a  class="text-danger mx-1"
          data-bs-toggle="modal"
          data-bs-target="#saleModal{{ cattle.id }}">
      <i class="bi bi-box-arrow-right fs-5"></i>
         </a>
  <!-- SALE MODAL -->
<div class="modal fade" id="saleModal{{ cattle.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header bg-danger">
        <h5 class="modal-title text-light">Sale / Salvage Cattle ({{ cattle.name }})</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form method="POST" action="{% url 'sell_cattle' cattle.id %}">
        {% csrf_token %}
        <div class="modal-body">

          <div class="mb-3">
            <label class="fw-bold">Sale Date</label>
            <input type="date" name="sale_date" required class="form-control">
          </div>

          <div class="mb-3">
            <label class="fw-bold">Sale Price (₹)</label>
            <input type="number" step="0.01" name="sold" required class="form-control">
          </div>
           
          <div class="mb-3">
           <label class="fw-bold">Status</label>
             <select class="form-control" name="salvage">
                <option value="Sale">Sale</option>
                <option value="Salvage">Salvage</option>
              </select>
            {% comment %} <textarea name="salvage" class="form-control" rows="3" placeholder="Enter remark here..."></textarea> {% endcomment %}
          </div>


        </div>

        <div class="modal-footer">
          <button class="btn btn-success px-4" type="submit">Confirm Sale</button>
          <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
        </div>

      </form>

    </div>
  </div>
 </div>


  <a href="{% url 'update_cattle' cattle.id %}" class="text-success mx-1">
    <i class="bi bi-pencil-square fs-5"></i>
</a>


  {% comment %} <a href="#" class="text-danger mx-1" onclick="return confirmDelete()"> <i class="bi bi-trash3-fill fs-5"></i></a> {% endcomment %}
</td>

        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>



             


    
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="copyright">
      &copy; Copyright <strong>J N Roadlines LLP</strong> All Rights Reserved
    </div>
    <div class="credits">
      Designed by <a href="#"><strong>JTECH VENTURES</strong></a>
    </div>
  </footer>

  <!-- Back to Top -->
  <a href="#" class="back-to-top d-flex align-items-center justify-content-center">
    <i class="bi bi-arrow-up-short"></i>
  </a>

  <script type="text/javascript">
    function confirmDelete() {
      return confirm("Are you sure you want to delete this data?");
    }
  </script>
  <script>
    const prefixes = ["A", "AA", "AB", "AC", "AD", "AE", "AF", "AG", "AH", "AI", "AJ", "AK", "AL"];

    document.getElementById("batchSelect").addEventListener("change", function () {
        const index = this.value;

        if (index === "") {
            document.getElementById("tagName").value = "";
            return;
        }

        document.getElementById("tagName").value = prefixes[index] + "-1";
    });
</script>

</body>
